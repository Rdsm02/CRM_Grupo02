<div class="row mr-0 ml-0">
    <div class="col-md-2" style="margin-top: 1%;">
        <label for="exampleFormControlTextarea6" class="float-right">Produto:</label>
    </div>
    <div class="col-md-4" style="">
        <select class="form-control" id="ProdutoSelect" data-placeholder="Selecione um Produto" style="margin-left: auto; margin-right: auto; width: 100%; margin: 0px auto 10px auto;">
			<option value="-1">Selecione um Produto</option>
			<option th:each="produto : ${produtoLista}" th:if="${produto.status.equals('1')}" th:value="${produto.id}"
				th:text="${produto.descricao}" />
		</select>

    </div>
    <div class="col-md-2" style="margin-top: 1%;">
        <label for="exampleFormControlTextarea6" class="float-right">Oferta:</label>
    </div>
    <div class="col-md-4" style="">
        <select class="form-control" id="OfertaSelect" data-placeholder="Selecione uma Oferta" style="margin-left: auto; margin-right: auto; width: 100%; margin: 0px auto 10px auto;">
			<option value="-1">Selecione uma Oferta</option>
			<!-- <option th:each="oferta : ${ofertaLista}" th:if="${oferta.status.equals('1')}" th:value="${oferta.id}" th:text="${oferta.descricao}" /> -->
		</select>

    </div>
</div>

<meta charset="UTF-8">
<div class="kanban-dragdrop ui-sortable d-flex" id="kt_sortable_portlets">

    <div class="col-md-2 col-lg-2 coluna" th:each="etapaInformacoes : ${listaEtapas}" th:if="${etapaInformacoes.status.equals('1')}">

        <div class="header-coluna">
            <div class="row">
                <input type="hidden" id="idEtapa" name="IdEtapa" th:value="${etapaInformacoes.id}"></input>
                <h6 class="col-md-12 text-center" th:text="${etapaInformacoes.descricao}"></h6>
            </div>
            <div class="row">
                <h6 class="col-md-5">
                    <span id="qtd-negocios">0</spam>&nbsp;Negócios
				</h6>
				<h6 class="col-md-2">
					<span id="espaco"> -> </spam>
				</h6>
				<h6 class="col-md-5 text-left">
					<span id="qtd-valor">R$ 0</spam>
				</h6>
			</div>
		</div>
		<div class="content-coluna">

			<!-- CARD -->

		</div>
	</div>
</div>
<script src="//code.jquery.com/jquery-1.12.4.js"></script>
<script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script>
	$(document).ready(function () {
		tornarCardDraggavel();
		tornarCardDroppavel();
		atualizarValoresKanban();

		function ativarCliqueNoCard() {
			console.log("testandos..")
			
			$(".card-kanban").click(function (e) { 
	
				var idCliente = $(this).find("div > div.col-md-8.mt-2 > #idCliente").val();
				var idOferta = $("#ProdutoSelect").find("option:selected").val();
				localStorage.setItem("idCliente",idCliente);
				localStorage.setItem("idOferta",idOferta);
				$("#central").load(dominio + "/cliente/detalheClienteOferta/" + idCliente);
				$("#navegacaoTitulo > span").text("Cliente Oferta: Detalhamento");
			});
		}




		$("#ProdutoSelect").change(function () {
			console.log($(this).find("option:selected").val());
			$.ajax({
				type: "GET",
				url: dominio + "/ofertaREST/obterOfertaPorProduto?produtoId=" + $(this).find("option:selected").val(),
				dataType: "JSON",
				async: false,
				success: function (response) {
					listaDeOfertas = response;
					$("#OfertaSelect").children().remove();
					$("#OfertaSelect").append('<option value="-1">Selecione uma Oferta</option>');
				},
				error: function (request, status, error) {
					$("#OfertaSelect").children().remove();
					$("#OfertaSelect").append('<option value="-1">Sem dados a listar</option>');
				}
			});
			$.each(listaDeOfertas, function (index, value) {
				$("#OfertaSelect").append('<option value="' + value.id + '">' + value.descricao + '</option>');
			});
		});


		$("#OfertaSelect").change(function () {
			console.log("teste");
			var ofertaId = $(this).find("option:selected").val();
			abrirKanban(ofertaId);


		});

		function abrirKanban(ofertaId) {
			var responseAjax = null;
			$.ajax({
				type: "GET",
				url: dominio + "/clienteClienteOfertaREST/buscarClienteOfertaPorOfertaId?ofertaId=" + ofertaId,
				dataType: "JSON",
				async: false,
				success: function (response) {
					responseAjax = response;
					popularKanban(responseAjax);
				},
				error: function (request, status, error) {
					Swal.fire({
					icon: 'warning',
					title: 'Oops...',
					text: 'Sem dados a Listar!'					
					})
				}
			});
			
		}

		function popularKanban(reponseDoAjax) {
			var listaDeColunas = $("#kt_sortable_portlets > div");

			if(reponseDoAjax.length === 0){
				Swal.fire({
					icon: 'warning',
					title: 'Oops...',
					text: 'Sem dados a Listar!'					
				})
			}

			$(listaDeColunas).each(function () {
				var droppable = $(this);
				var idEtapa = droppable.find('.header-coluna > div:nth-child(1) > input').val();
				droppable.find('div.content-coluna').children().remove();

				$.each(reponseDoAjax, function (index, value) {
					if (value.funilEtapa === parseInt(idEtapa)) {

						droppable.find('div.content-coluna').append('<div class="kt-portlet kt-portlet--tabs kt-portlet--sortable card-kanban" style="border-radius: 10px;">'

							+ '<div class="row" style="margin: 0px; border-radius: 10px; padding: 0px; background-color: #838849;">'
							+ '	<div class="col-md-4 mt-2">'
							+ '		<i class="la fa fa-suitcase"></i>'
							+ '	</div>'
							+ '	<div class="col-md-8 mt-2">'
							+ '		<input type="hidden" id="idCliente" name="idCliente" value="' + value.idCliente.toString() + '"> '
							+ '		<p class="text-left font-weight-bold mb-2">' + value.clienteNome + '</p>'
							+ '		<p class="text-left">R$ ' + value.clienteOfertaPreco + '</p>'
							+ '	</div>'
							+ '	<div class="col-md-4 mb-2">'
							+ '		<i class="la flaticon2-user"></i>'
							+ '	</div>'
							+ '	<div class="col-md-8 mt-3">'
							+ '		<p class="text-left font-weight-bold mb-0">' + value.qtdAcoesClienteOferta + ' Atividades</p>'
							+ '	</div>'
							+ ' </div>'
							+ '</div>');

					}
				});

			});
			tornarCardDraggavel();
			tornarCardDroppavel();
			atualizarValoresKanban();
			ativarCliqueNoCard();
		}

		var tamanhoEtapas = $("#kt_sortable_portlets > div").size();
		var teste = "1";

		function tornarCardDroppavel() {

			var listaDeColunas2 = $("#kt_sortable_portlets > div");

			$(listaDeColunas2).each(function () {
				var droppable2 = $(this);
				droppable2.droppable({
					drop: function (event, ui) {
						droppable2.find("div.content-coluna").append(ui.draggable.css({ left: "0", top: "10px" }));
						var idEtapa = droppable2.find('.header-coluna > div:nth-child(1) > input').val();
						var idClienteOferta =  $(this).find("div > div.col-md-8.mt-2 > #idCliente").val();
						var ofertaId = $("#ProdutoSelect").find("option:selected").val();
						
						var objeto = new Object();
						objeto.clienteId = new Object();
						objeto.ofertaId = new Object();
						objeto.funilEtapa = new Object();
						objeto.clienteId.id = idClienteOferta;
						objeto.ofertaId.id = ofertaId;
						objeto.funilEtapa.id = idEtapa;

						var ClienteOfertaAtualizarEtapaJSON = JSON.stringify(objeto);

						$.ajax({
							type: "POST",
							url: dominio + "/clienteClienteOfertaREST/atualizarEtapaDoClienteOferta",
							data: ClienteOfertaAtualizarEtapaJSON,
							contentType: "application/json",
							dataType: "JSON",
							async: false,
							success: function (response) {
								console.log("ok");
							},
							error: function (request, status, error) {
								console.log(error);

							}
						});
						atualizarValoresKanban();
					}
				})
			})
		}

		function tornarCardDraggavel() {
			$(".card-kanban").css("z-index", "0");
			$(".card-kanban").draggable({
				start: function (event, ui) {
					$(this).css("z-index", "20");
				}
			});
		}


		function atualizarValoresKanban() {

			var listaDeColunas3 = $("#kt_sortable_portlets > div");

			$(listaDeColunas3).each(function () {
				var droppable3 = $(this);
				var colunaAtual = droppable3.find("div.content-coluna");
				var valorTotal1 = 0;
				var cards = colunaAtual.find("div.card-kanban");
				cards.each(function () {
					valorTotal1 += parseFloat($(this).find("div > div.col-md-8.mt-2 > p:nth-child(3)").text().substring(3, 20));
				});
				var qtdCards = colunaAtual.find("div.card-kanban").size();
				var valorCards = valorTotal1;

				droppable3.find("div.header-coluna").find("#qtd-negocios").text(qtdCards + " Negócios");
				droppable3.find("div.header-coluna").find("#qtd-valor").text("R$ " + valorCards);

			})
		}		

	});
</script>